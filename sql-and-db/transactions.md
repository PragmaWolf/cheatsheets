**[SQL, Базы данных](../../README.md#sql-базы-данных) ::**
# Транзакции

Транзакция это упорядоченное множество операций, переводящих базу данных из одного согласованного состояния в другое. Еще можно описать как набор последовательных операций с базой данных, соединенных в одну логическую единицу.

Транзакции должны следовать требованиям [ACID](../concepts/acid.md).

Транзакция позволяет сгруппировать запросы к БД, то есть фактически показывает базе на взаимосвязи между ними.

**Неявные транзакции** - предусмотрены на уровне базы данных. Например, БД задает отдельную инструкцию `INSERT`, `UPDATE` или `DELETE` как единицу транзакции.

**Явные транзакции** - их начало и конец явно обозначаются такими инструкциями, как `BEGIN TRANSACTION`, `COMMIT` или `ROLLBACK`.

Группу операторов, окружённых командами `BEGIN` и `COMMIT` иногда называют блоком транзакции.

Операторами в транзакции можно также управлять на более детальном уровне, используя точки сохранения. Точки сохранения позволяют выборочно отменять некоторые части транзакции и фиксировать все остальные. Определив точку сохранения с помощью `SAVEPOINT`, при необходимости вы можете вернуться к ней с помощью команды `ROLLBACK TO`. Все изменения в базе данных, произошедшие после точки сохранения и до момента отката, отменяются, но изменения, произведённые ранее, сохраняются. При удалении или откате к точке сохранения все точки сохранения, определённые после неё, автоматически уничтожаются.

При явном старте транзакции `START TRANSACTION` autocommit выключен по умолчанию.

[К оглавлению](../README.md#sql-базы-данных)

## Уровни изоляции транзакций

Проблемы параллельно выполняющихся транзакций:
- **Эффект потерянного обновления** (аномалия сериализации) возникает, когда несколько транзакций обновляют одни и те же данные, не учитывая изменений, сделанных другими транзакциями.
- **Эффект "грязного" чтения** возникает, когда транзакция считывает данные, которые еще не были зафиксированы.
- **Эффект неповторяемого чтения** возникает, когда транзакция считывает дважды одну и ту же строку, но каждый раз получает разные результаты.
- **Эффект чтения фантомов** возникает, когда набор данных соответствует условиям поиска, но изначально не отображается.

Эти проблемы должны решаться уровнями изоляции транзакций.

[К оглавлению](../README.md#sql-базы-данных)

### Read uncommitted
Уровень изоляции, при котором каждая транзакция видит незафиксированные изменения другой транзакции.

Все запросы `SELECT` считывают данные в неблокирующей манере.

Блокирующее чтение (`SELECT … FOR UPDATE`, `LOCK IN SHARE MODE`), `UPDATE` и `DELETE` блокирует искомые индексные строки. Таким образом, возможна вставка данных в промежутки между индексами. Промежутки блокируются только при проверках на дублирующиеся и внешние ключи.

Решает проблемы:
- Эффект потерянного обновления.

Не решает проблемы:
- Эффект "грязного" чтения.
- Эффект неповторяемого чтения.
- Эффект чтения фантомов.

[К оглавлению](../README.md#sql-базы-данных)

### Read committed
Уровень изоляции, при котором параллельно исполняющиеся транзакции видят только зафиксированные изменения других транзакций.

Не накладывает блокировок, однако считывает данные из свежего снэпшота. В остальном ведёт себя так же, как и read uncommitted.

> Установлен по умолчанию в PostgreSQL

Решает проблемы:
- Эффект потерянного обновления.
- Эффект "грязного" чтения.

Не решает проблемы:
- Эффект неповторяемого чтения.
- Эффект чтения фантомов.

[К оглавлению](../README.md#sql-базы-данных)

### Repeatable read или Snapshot isolation
Уровень изоляции, при котором транзакция не видит изменения данных, прочитанные ей ранее, однако способна прочитать новые данные, соответствующие условию поиска.

Не накладывает блокировок и считывает данные из снэпшота, который создается при первом чтении в транзакции. Таким образом, одинаковые запросы вернут одинаковый результат.

Блокировка для блокирующего чтения будет зависеть от типа условия:
- если условие с диапазоном, например,` WHERE id > 7`, то блокируется весь диапазон;
- если уникальное, например, `WHERE id = 7`, то блокируется одна индексная запись.

Решает проблемы:
- Эффект потерянного обновления.
- Эффект "грязного" чтения.
- Эффект неповторяемого чтения.

Не решает проблемы:
- Эффект чтения фантомов.

[К оглавлению](../README.md#sql-базы-данных)

### Serializable
Уровень изоляции, при котором каждая транзакция выполняется так, как будто параллельных транзакций не существует.

Аналогично **Repeatable read**, но есть интересный момент. Если выключен autocommit, то все запросы `SELECT` превращаются в запросы `SELECT … LOCK IN SHARE MODE`.
- `SELECT … LOCK IN SHARE MODE` – блокирует считываемые строки на запись.
- `SELECT … FOR UPDATE` – блокирует считываемые строки на чтение.

Решает проблемы:
- Эффект потерянного обновления.
- Эффект "грязного" чтения.
- Эффект неповторяемого чтения.
- Эффект чтения фантомов.

[К оглавлению](../README.md#sql-базы-данных)
